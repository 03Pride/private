<u>本文引用哈工深南工骁鹰CAN教学</u>：https://www.bilibili.com/video/BV1kD4y1t78S/?spm_id_from=333.788.top_right_bar_window_history.content.click&vd_source=082b639c1ecbc1d347bdfb85e31a74b4

# CAN总线简介

* 控制器局域网络，Controller Area Network

* 异步半双工通信协议

## 总线制

* CAN由一对差分对（两条线）CANH和CANL组成
* CANH电压比CANL高视为逻辑0（显性电平），否则为逻辑1（隐性电平）
* 多个设备可以连接同一条CAN上，某一时刻，总线上只会表示一条信号
* 总线上的设备通过ID号区分
* ID号长度可以分为11位（标准长度）或29位（拓展长度）

## CAN2.0b标准（老式）

* 最大速率1Mbps
* 一组数据称作一帧，分为数据帧和远程帧（不常用）
* 数据帧最多传输8字节的数据
* 每一帧都有CRC校验

## CAN FD标准

* 最大速率可达8Mbps
* 数据帧最多传输64字节数据

## CAN物理层

* 单片机一般使用类似串口的CAN RX和CAN TX接口驱动CAN
* CAN RX/CAN TX需要经过CAN收发器（Transceiver)才能被转换成对应的差分电平
* 一般CAN差分信号的电压为0~5V，也可以是0~3.3V（不建议）

## CAN总线结构

* CAN有两个120Ω终端电阻，位于CAN布线的两端
* 主控板集成了这个电阻

* 每个设备挂载在总线上形成数个支路

  ![](C:\Users\Pride\Desktop\CAN.jpg)

## CANS时序

* CAN每一位会被分成数个Time Quanta (Tq),一般在10个以上

* CAN通信以Tq为基本时间单位

* 每一位的时间长度可以调整以保证同步

* 每一位被分为3段：同步段（1个Tq),BS1(图中Prop+Phase1,多个Tq)和BS2（多个Tq)

* BS1和BS2中间会进行接收的采样

* CAN的实际工作频率会比通信速率更高

* ![CAN2](C:\Users\Pride\Desktop\CAN2.jpg)

  

## CAN的帧

 * ID：ID号

 * RTR：区别远程帧与数据帧

 * IDE：区别ID号长度(0为11位，1位29位)

 * DLC：数据长度

 * CRC：校验部分

 * 连续的5个以上相同位中间会插入一个相反位（除结尾外）

 * ![CAN3](C:\Users\Pride\Desktop\CAN3.jpg)

   

## 仲裁

* 由于CAN定义2条信号线的电压差代表逻辑0或逻辑1，CAN的两条信号线实质等效于串口的一条线
* 发送和接收不能同时进行
* **当总线上连续3位的时间为1且没有正在传输的帧时，视为空闲状态，此时设备才能进行发送**
* 如果有2个或以上设备同时启动则会进入仲裁
  * 发送0更多的设备会赢得仲裁并继续发送
  * 由于CAN时序的规定，仲裁是很难进入的，只有2个设备在同一Tq内启动了发送才会进入仲裁

## STM32的CAN外设

* FDCAN:仅限H系列和G系列（第三代STM32）支持
  * 支持FDCAN和CAN2.0b
* bxCAN:标准CAN外设，仅支持CAN2.0b
  * 一般有1~3个CAN
  * CAN1和CAN3是主CAN，CAN2是从CAN
  * CAN2仅在CAN1打开后才能打开
  * 推荐CAN1和CAN2同时打开使用

## STM32的bxCAN结构

* 每个CAN具有3个发送邮箱和6个接收邮箱

* 邮箱用于暂存数据（类似串口缓存区）
* 接收邮箱分为2组FIFO，可触发不同的中断（向量不同）
* 外设会自动管理这些邮箱的发送和接收队列
* 2个CAN共享28个过滤器，用于过滤接收的ID号

## STM32的CAN时序![CAN4 ](C:\Users\Pride\Desktop\CAN4 .jpg)

​															**BS1上限为16，BS2上限是8**

​															**队内为BS1=3，BS2=3,PSC=6，保证Tq尽量小**

# CAN的过滤器

* STM32的bxCAN接收时必须使用过滤器接收
* 根据CAN外设数量的不同有以下情况：
  * 只有CAN1：CAN1有14个过滤器
  * 有CAN1和CAN2：CAN1和CAN2共享28个过滤器
  * 有CAN1~CAN3：CAN1和CAN2共享28个过滤器，CAN3有独立的14个过滤器
* 过滤器可以过滤CAN总线上帧的ID号
  * 可以不处理不想接收的ID号，只接收想要的ID号

## 过滤器的过滤模式

* 理解

  * 假设我们是bxCAN这个IP的设计者，现在由我们来设计过滤器，那么我们该如何设计呢？

  ​	首先我们是不是很快就会想到只要准备好一张表，把我们需要关注的所有CAN报文ID写上去，开始过滤的时候只要对比这张表，如果接收到的报文ID与表上的相符，则通过，如果表上没有，则不通过，这个就是简单的过滤方案。恭喜你！bxCAN过滤器的列表模式采用的就是这种方案。 

  ​	但是，这种列表方案有点缺陷，即如果我们只关注一个报文ID，则需要往列表中写入这个ID，如果需要关注两个，则需要写入两个报文ID，如果需要关注100个，则需要写入100个，如果需要1万个，那么需要写入1万个，可问题是，有这个大的列表供我们使用吗？大家都知道，MCU上的资源是有限的，不可能提供1万个或更多，甚至100个都嫌多。非常明显，这种列表的方式受到列表容量大小的限制，实际上，bxCAN的一个过滤器若工作在列表模式下,scale为32时，每个过滤器的列表只能写入两个报文ID，若scale为16时，每个过滤器的列表最多可写入4个CAN ID，由此可见，MCU的资源是非常非常有限的，并不能任我们随心所欲。因此，我们需要考虑另外一种替代方案，这种方案应该不受到数量限制。

* 过滤器总长度64位，可以分成2个32位单元或4个16位单元

* 两种过滤模式：掩码和列表

  * 列表模式：由一个单元组成，ID号完全匹配即通过(对于ID号有针对性)
  * 掩码模式：由两个单元组成，通过掩码匹配（对于ID号的选取有范围性）
  * ID号对齐最高位（MSB）
  * 仅32位单元可以过滤拓展ID

  

  ## 掩码

* 两个单元分别组成匹配ID和掩码（MASK）
* 被过滤的ID号和匹配ID号会和掩码进行按位与运算后再进行匹配
  * 也就是只有对应的掩码为1的位才会被匹配
* 例如：
  匹配ID为0x200,掩码为0x000,则所有ID号都能通过
  匹配ID为0x200，掩码为0x700，则ID为0x200~0x2FF均可通过
  匹配ID为0x200，掩码为0x7FF，则ID为0x200能通过

## 验证码和屏蔽码

对于机器来说，我们要为它准备好两张纸片，一片写上屏蔽码，另一片纸片写上验证码，屏蔽码上相应位为1时，表示此位需要与验证码对应位进行比较，反之，则表示不需要。机器在执行任务的时候先将获取的身份证号码与屏蔽码进行“与”操作，再将结果与验证码的进行比较，根据判断是否相同来决定是否通过。整个判别流程如下所示：
![img](https://img-blog.csdn.net/20160825193756895)

从上图可以很容易地理解屏蔽码与验证码的含义，这样一来，能通过的结果数量就完全取决于屏蔽码（屏蔽码对应的0越多，能通过的数量越多），设得宽，则可以通过的多(所有位为0，则不过任何过滤操作，则谁都可以通过)，设得窄，则通过的少(所有位设为1，则只有一个能通过)。那么知道这个有什么用呢？因为bxCAN的过滤器的掩码模式就是采用这种方式，在bxCAN中，分别采用了两个寄存器(CAN_FiR1,CAN_FiR2)来存储屏蔽码与验证码，从而实现掩码模式的工作流程的。这样,我们就知道了bxCAN过滤器的掩码模式的大概工作原理。

但是，我们得注意到，采用掩码模式的方式并不能精确的对每一个ID进行过滤，打个比方，还是采用之前的守卫的例子，假如城主要求只有1150~1158年出生的人能通过，那么，若我们还是才用掩码模式，那么掩码就设为第7~9位为”1”，对应的，验证码的7~9位分别为”115”，这样就可以了。但是，仔细一想，出生于1159的人还是可以通过，是不是？但总体来说，虽然没有做到精确过滤，但我们还是能做到大体过滤的，而这个就是掩码模式的缺点了。在实际应用时，取决于需求，有时我们会同时使用到列表模式和掩码模式，这都是可能的。

原文链接：https://blog.csdn.net/flydream0/article/details/52317532

## 列表模式和掩码模式对比

| 模式     | 优点                                                         | 缺点                         |
| -------- | :----------------------------------------------------------- | ---------------------------- |
| 列表模式 | 能精确地过滤每个指定的CAN ID                                 | 有数量限制                   |
| 掩码模式 | 取决于屏蔽码，有时无法完全精确到每一个CAN ID，部分不期望的CAN ID有时也会收到 | 数量取决于屏蔽码，最多无上限 |

## CAN的双接收中断

* 每个CAN有2个接收中断，对应两组接收邮箱
* 每个过滤器可以绑定一个CAN接收中断
* 经过过滤器过滤的帧会进入该过滤器绑定的接收中断对应的邮箱
* 匹配时，列表模式的优先级高于掩码模式，其次过滤器编号更小的优先级更高

## 标准CAN ID与扩展CAN ID

![image-20230103202352039](C:\Users\Pride\AppData\Roaming\Typora\typora-user-images\image-20230103202352039.png)





# STM32CubeMX配置

## 选定C板型号

​	![image-20230102030452804](C:\Users\Pride\AppData\Roaming\Typora\typora-user-images\image-20230102030452804.png)

## 配置CAN参数

* 先配置BS1和BS2，否则会报错

![image-20230102030630063](C:\Users\Pride\AppData\Roaming\Typora\typora-user-images\image-20230102030630063.png)

* 开启CAN中断

  ![image-20230102031023766](C:\Users\Pride\AppData\Roaming\Typora\typora-user-images\image-20230102031023766.png)

  

## 配置时钟树

![image-20230102030727134](C:\Users\Pride\AppData\Roaming\Typora\typora-user-images\image-20230102030727134.png)

## 生成工程

![image-20230102030801775](C:\Users\Pride\AppData\Roaming\Typora\typora-user-images\image-20230102030801775.png)

